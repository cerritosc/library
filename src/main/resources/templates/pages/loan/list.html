<!--decorated page-->
<html lang="en" dir="ltr" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" xmlns:th="http://www.thymeleaf.org"
      layout:decorate="~{layouts/basic-layout}">

<head>
    <title th:inline="text" th:text="#{label.list} + ' ' + 'Loan'"></title>

    <!-- Custom CSS from main page-->
</head>

<body>
<section layout:fragment="content" th:remove="tag">
<div class="container-fluid">
    <div class="header">
        <h1 class="header-title" th:inline="text" th:text="'Loans'"></h1>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a th:href="@{/index}" th:inline="text" th:text="'Home'"></a></li>
                <li class="breadcrumb-item active" aria-current="page" th:inline="text" th:text="'Loans'"></li>
            </ol>
        </nav>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <th:block th:insert="~{fragments/service-response-painter}" th:remove="tag"/>
                    <div class="card-title col-lg-2">
                        <button class="btn btn waves-effect waves-light btn-block btn-info"
                                th:inline="text" th:onclick="modalToggle()"><i class="fa fa-plus-circle pr-1"></i>New loan</button>
                    </div>
                    <div class="table-responsive">
                        <table id="tblLoan" class="table table-hover table-bordered" width="100%">
                            <thead>
                            <tr>
                                <th>Acciones</th>
                                <th>id</th>
                                <th>bookIdDelegate</th>
                                <th>Book</th>
                                <th>bookSelect2Delegate</th>
                                <th>userIdDelegate</th>
                                <th>User</th>
                                <th>userSelect2Delegate</th>
                                <th>lentFrom</th>
                                <th>lentTo</th>
                            </tr>
                            </thead>
                        </table>
                    </div>

                </div>
            </div>
        </div>
    </div>
    <!-- modal-content -->
    <div id="loanModal" class="modal bs-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true" style="display: none;">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="myLargeModalLabel">Loan</h4>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-hidden="true"></button>
                </div>
                <form enctype="multipart/form-data" id="formLoan" class="needs-validation needs-validation-manual form-horizontal" novalidate th:action="@{/loan/save}" method="POST">
                <div class="modal-body">
                        <div class="card-body">
                            <div class="col-sm-12 col-lg-12">
                                <div class="form-group row">
                                        <label for="bookSelect2Delegate" class="col-sm-2 text-right control-label col-form-label">Book</label>
                                        <div class="col-sm-9">
                                                <select class="select2" id="bookSelect2Delegate" name="book" required>
                                                    
                                                </select>
                                                <span id="bookSelect2DelegateError" style="display: none; color: red;">Campo obligatorio</span>
                                        </div>
                                </div><br/>
                                <div class="form-group row">
                                        <label for="userSelect2Delegate" class="col-sm-2 text-right control-label col-form-label">User</label>
                                        <div class="col-sm-9">
                                                <select class="select2" id="userSelect2Delegate" name="user" required>
                                                    
                                                </select>
                                                <span id="userSelect2DelegateError" style="display: none; color: red;">Campo obligatorio</span>
                                        </div>
                                </div><br/>
                                <div class="form-group row mb-3">
                                    <label for="lentFrom" class="col-sm-2 text-right control-label col-form-label">Lent from</label>
                                    <div class="col-sm-9">
                                        <div class="input-group">
                                            <input type="text" class="form-control datepicker-initializer" id="lentFrom" name="lentFrom" 
                                                placeholder="dd/mm/yyyy" autocomplete="off" />
                                            <div class="input-group-append">
                                                <span class="input-group-text" style="height: 100%;"><i class="fa fa-calendar"></i></span>
                                            </div>
                                        </div>
                                        <span id="lentFromError" style="display: none; color: red;">Campo obligatorio</span>
                                    </div>
                                </div>
                                <input type="hidden" id="id" name="id"/>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-info waves-effect waves-light" th:text="'save'"></button>
                        <button type="button" class="btn btn-danger waves-effect text-left" data-bs-dismiss="modal" th:text="'cancel'"></button>
                    </div>
                </form>
            </div>
            <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
    </div>
    <!-- modal-content 2 -->
    <div id="loanModal2" class="modal bs-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true" style="display: none;">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="myLargeModalLabel2">Return</h4>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-hidden="true"></button>
                </div>
                <form enctype="multipart/form-data" id="formLoan2" class="needs-validation needs-validation-manual form-horizontal" novalidate th:action="@{/loan/save}" method="POST">
                <div class="modal-body">
                        <div class="card-body">
                            <div class="col-sm-12 col-lg-12">
                                <div class="form-group row">
                                        <label for="bookSelect2Delegate" class="col-sm-2 text-right control-label col-form-label">Book</label>
                                        <div class="col-sm-9">
                                                <input type="text" class="form-control" id="bookSelect2Delegate2" name="bookSelect2Delegate2" />
                                                
                                        </div>
                                </div><br/>
                                <div class="form-group row">
                                        <label for="userSelect2Delegate" class="col-sm-2 text-right control-label col-form-label">User</label>
                                        <div class="col-sm-9">
                                                <input type="text" class="form-control" id="userSelect2Delegate2" name="userSelect2Delegate2" readonly />
                                                
                                        </div>
                                </div><br/>
                                <div class="form-group row mb-3">
                                    <label for="lentFrom" class="col-sm-2 text-right control-label col-form-label">Lent from</label>
                                    <div class="col-sm-9">
                                        <div class="input-group">
                                            <input type="text" class="form-control datepicker-initializer" id="lentFrom2" name="lentFrom" 
                                                placeholder="dd/mm/yyyy" readonly />
                                            <div class="input-group-append">
                                                <span class="input-group-text" style="height: 100%;"><i class="fa fa-calendar"></i></span>
                                            </div>
                                        </div>
                                        <span id="lentFromError" style="display: none; color: red;">Campo obligatorio</span>
                                    </div>
                                </div>
                                <div id="divLentTo">
                                <div class="form-group row mb-3">
                                    <label for="lentTo" class="col-sm-2 text-right control-label col-form-label">Lent to</label>
                                    <div class="col-sm-9">
                                        <div class="input-group">
                                            <input type="text" class="form-control datepicker-initializer" id="lentTo2" name="lentTo" 
                                                placeholder="dd/mm/yyyy" autocomplete="off" />
                                            <div class="input-group-append">
                                                <span class="input-group-text" style="height: 100%;"><i class="fa fa-calendar"></i></span>
                                            </div>
                                        </div>
                                        <span id="lentFromError" style="display: none; color: red;">Campo obligatorio</span>
                                    </div>
                                </div>
                                </div>
                                <input type="hidden" id="id2" name="id"/>
                                <input type="hidden" id="idBook" name="book.id"/>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-info waves-effect waves-light" th:text="'save'"></button>
                        <button type="button" class="btn btn-danger waves-effect text-left" data-bs-dismiss="modal" th:text="'cancel'"></button>
                    </div>
                </form>
            </div>
            <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
    </div>
</div>
</section>

<section layout:fragment="js" th:remove="tag">
    <!-- Required libraries -->

    <script th:inline="javascript">
        const urlBookSelect2 = /*[[@{/book/cboFilterS2}]]*/"";
        const urlUserSelect2 = /*[[@{/user/cboFilterS2}]]*/"";
        const urlLoanDataTable = /*[[@{/loan/list}]]*/"";
        const urlGetLoan = /*[[@{/loan/form}]]*/"";
        const urlSaveLoan = /*[[@{/loan/save}]]*/"";
        const urlDeleteLoan = /*[[@{/loan/delete}]]*/"";
        const urlReturn = /*[[@{/loan/return}]]*/"";
    </script>
    <script>
        /*DatePicker init*/
        jQuery('.datepicker-initializer').datepicker({
            format: "dd/mm/yyyy",
            autoclose: true,
            todayHighlight: true,
            orientation: "bottom",
            language: "es"
        });
        /*Select 2 init*/
        renderSelect2('#bookSelect2Delegate', urlBookSelect2,5);
        renderSelect2('#userSelect2Delegate', urlUserSelect2,5);

        var table = $('table#tblLoan').DataTable({
            ajax: urlLoanDataTable,
            serverSide: true,
            orderCellsTop: true,
            fixedHeader: true,
            columns: [
                {
                    targets: -1,
                    data: null,
                    searchable: false,
                    orderable: false,
                    width: "10%",
                    render: function (data, type, row) {
                        var id = row.id;
                        var lentTo = row.lentTo;
                        let btns = "";
                        
                        if(lentTo==null){
							btns = '<div class="button-group" style="display: inline-flex;">' +
                                    '<button title="Editar" class="btn waves-effect waves-light btn-success" type="button" onClick="ajaxEdit(\'' + id + '\')" id="btnEditar_' + id + '" > <i class="fa fa-pencil-alt"></i></button>' +
                                    //'<button title="Eliminar" class="btn waves-effect waves-light btn-danger" type="button" onClick="ajaxDelete(\'' + id + '\')" id="btnEliminar_' + id + '" > <i class="fa fa-trash"></i> </button>' +
                                '</div>';
						}
                        return btns;
                    }
                }
                , {
                    data: 'id',
                    orderable: false
                    , visible: false
                    , searchable: false
                }
                , {
                    data: 'bookIdDelegate',
                    visible: false,
                    searchable: false
                }
                , {
                    data: 'book.id',
                    render: function (data, type, row) {
                        return row.bookStDescripcionDelegate;
                    },
                    orderable: false,
                    filterType: "select2",
                    filterUrl: urlBookSelect2
                }
                , {
                    data: 'bookSelect2Delegate',
                    visible: false,
                    searchable: false
                }
                , {
                    data: 'userIdDelegate',
                    visible: false,
                    searchable: false
                }
                , {
                    data: 'user.id',
                    render: function (data, type, row) {
                        return row.userStDescripcionDelegate;
                    },
                    orderable: false,
                    filterType: "select2",
                    filterUrl: urlUserSelect2
                }
                , {
                    data: 'userSelect2Delegate',
                    visible: false,
                    searchable: false
                }
                , {
                    data: 'lentFrom'
                    , orderable: false
                    , filterType: "date"
                }
                , {
                    data: 'lentTo'
                    , orderable: false
                    , filterType: "date"
                }
            ]
        });

        crearFiltrosDataTable("#tblLoan", table);

        table.findById = function(id) {
            return this.data()
                .filter( function ( value, index ) {
                    return String(id) === String(value.id);
            })[0];
        };

        //Modal launch and clear Form
        function modalToggle(){
            var form = $("#formLoan");
            resetForm(form);
            $('#loanModal').modal('toggle');
        }

        //Ajax Save for Modal, called after submit validation.
        function ajaxSave(){
            var id = $("#id").val();
            var mensaje = id ? 'A record will be created' : 'Se guardará un nuevo registro';
            Swal.fire({
                title: "¿Continue?",
                text: mensaje,
                type: "warning",
                showCancelButton: true,
                confirmButtonColor: "#3085d6",
                cancelButtonColor: '#d33',
                confirmButtonText: "Yes",
                cancelButtonText: "No"
            }).then(function (e) {
                if (e.value === true) {
                    $.ajax({
                        data: $("#formLoan").serialize(),
                        url: urlSaveLoan,
                        type: "POST",
                        success: function (result) {
                            if (result.success === true) {
                                Swal.fire({title: "¡Lent!", text: "Book marked as lent", type:'success'});
                                $('#loanModal').modal('toggle');
                                $('#tblLoan').DataTable().ajax.reload();
                            }else{
                                Swal.fire({title: "Error!", text: result.message, type:'error'});
                            }
                        },
                        error: function (x, e,  thrownError) {
                            Swal.fire({title: "Error!", text: "Error interno del servidor.", type:'error'});
                        }
                    });
                }
            });
            return false;
        }
        
        function ajaxReturn(){
            var id = $("#id").val();
            var mensaje = id ? 'Book will be marked as returned' : 'Book will be marked as returned';
            Swal.fire({
                title: "¿Continue?",
                text: mensaje,
                type: "warning",
                showCancelButton: true,
                confirmButtonColor: "#3085d6",
                cancelButtonColor: '#d33',
                confirmButtonText: "Yes",
                cancelButtonText: "No"
            }).then(function (e) {
                if (e.value === true) {
                    $.ajax({
                        data: $("#formLoan2").serialize(),
                        url: urlReturn,
                        type: "POST",
                        success: function (result) {
                            if (result.success === true) {
                                Swal.fire({title: "¡Returned!", text: result.message, type:'success'});
                                $('#loanModal2').modal('toggle');
                                $('#tblLoan').DataTable().ajax.reload();
                            }else{
                                Swal.fire({title: "Error!", text: result.message, type:'error'});
                            }
                        },
                        error: function (x, e,  thrownError) {
                            Swal.fire({title: "Error!", text: "Internal server error.", type:'error'});
                        }
                    });
                }
            });
            return false;
        }

        //Ajax Edit
        function ajaxEdit(id){
            var id = id;
            var form = $("#formLoan2");
            $.ajax({
                data: {id : id},
                url: urlGetLoan,
                type: 'GET',
                success: function (result){
                    if(result !== null){
                        fillForm(form, result);
                        $("#id2").val(result.id);
                        $("#idBook").val(result.bookIdDelegate);
                        $("#bookSelect2Delegate2").val(result.bookStDescripcionDelegate);
                        $("#userSelect2Delegate2").val(result.userStDescripcionDelegate);
                        $("#lentFrom2").val(result.lentFrom);
                        
                        $('#bookSelect2Delegate2').attr('readonly', true);
                        $('#userSelect2Delegate2').attr('readonly', true);
                        $('#lentFrom2').attr('readonly', true);
                        
                        $('#loanModal2').modal('toggle');
                    }else{
                        Swal.fire({title: "Error!", text: "No se encontró el registro seleccionado.", type:'error'});
                    }
                },
                error: function (xhr, status) {
                    Swal.fire({title: "Error!", text: "Error interno del servidor.", type:'error'});
                }
            });
        }

        //Ajax Edit
        function ajaxEdito(id){
            var id = id;
            var form = $("#formLoan");
            $.ajax({
                data: {id : id},
                url: urlGetLoan,
                type: 'GET',
                success: function (result){
                    if(result !== null){
                        fillForm(form, result);
                        $('#loanModal').modal('toggle');
                    }else{
                        Swal.fire({title: "Error!", text: "No se encontró el registro seleccionado.", type:'error'});
                    }
                },
                error: function (xhr, status) {
                    Swal.fire({title: "Error!", text: "Error interno del servidor.", type:'error'});
                }
            });
        }

        //Ajax Delete
        function ajaxDelete(id){
            var id = id;
            Swal.fire({
                title: '¿Está seguro?',
                text: "Se eliminará el registro",
                type: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Si',
                cancelButtonText: 'No'
            }).then(function(e) {
                if (e.value === true) {
                    $.ajax({
                        data: {id : id} ,
                        url: urlDeleteLoan,
                        type: 'POST',
                        success: function (result) {
                            if (result.success === true) {
                                Swal.fire({title: "¡Eliminado!", text: result.message, type:'success'});
                                $('#tblLoan').DataTable().ajax.reload();
                            } else {
                                Swal.fire({title: "¡Error!", text: result.message, type:'error'});
                            }
                        },
                        error: function (x, e,  thrownError) {
                            Swal.fire({title: "¡Error!", text: "Error interno del servidor.", type:'error'});
                        }
                    });
                }
            });
        }
        
        /* Submit validation, antes de ejecutar la funcion de guardado ajaxSave() */
        $('#formLoan').submit(function(event){
           var formulario =  $('#formLoan');

           // cancels the form submission
            event.preventDefault();
            event.stopPropagation();

           var validacionBootstrapCorrecta = formulario[0].checkValidity();
           var validacionManualCorrecta = Validador.validarFormulario(formulario);
           if (validacionBootstrapCorrecta && validacionManualCorrecta) {
               ajaxSave();
           }         
           formulario.addClass('was-validated');
       });
       $('#formLoan2').submit(function(event){
           var formulario =  $('#formLoan2');

           // cancels the form submission
            event.preventDefault();
            event.stopPropagation();

           var validacionBootstrapCorrecta = formulario[0].checkValidity();
           var validacionManualCorrecta = Validador.validarFormulario(formulario);
           if (validacionBootstrapCorrecta && validacionManualCorrecta && $('#lentTo2').val()!='') {
               ajaxReturn();
           }         
           else{
			   Swal.fire({title: "", text: "Date must be entered", type:'error'});
		   }
           formulario.addClass('was-validated');
       });
    </script>
</section>
</body>

</html>
